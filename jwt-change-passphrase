#!/bin/sh

CURL=curl
PORT=443

while getopts s:l:p: OPT
do
  case $OPT in
    "s" ) HOST="$OPTARG" ;;
    "l" ) ACCOUNT="$OPTARG" ;;
    "p" ) PORT="$OPTARG" ;;
      * ) echo "Usage: $CMDNAME [-s HOST] [-l USER]" 1>&2
          exit 1 ;;
  esac
done

if [ -z "$HOST" -o -z "$ACCOUNT" ]; then
 echo "Usage: $CMDNAME [-s HOST] [-l USER]" 1>&2
 exit 1
fi

if [ -t 0 ]; then
  echo -n "Passphrase: "
  trap "stty echo" HUP INT QUIT TERM
  stty -echo
  read PASS
  stty echo

  echo
else
  read PASS
fi

URL=https://$HOST:$PORT/jwt-server/chpass

COMMAND="$CURL -m 10 -X POST -d user=$ACCOUNT -d pass=$PASS $URL"

PASSPHRASE=`$COMMAND 2>/dev/null`
curl_ret=$?
#curl's exit status is 0 at authentication error

expr "$JWT" : '.*Error.*' > /dev/null
jwt_ret=$?

if  [ $curl_ret -ne 0 ] || [ -z "$PASSPHRASE" ] || [ $jwt_ret -eq 0 ]; then
#error
  echo "Failed"
  exit 1
else
  echo $PASSPHRASE
  exit 0
fi
